---
title: 客户端宕机服务端咋知道  
date: 2023-02-08 00:00  
tags: [客户端宕机服务端咋知道]  
source: https://blog.csdn.net/ba_wang_mao/article/details/107547741
---

## 结论
（1）使用定时器（适合有数据流动的情况）。  
（2）使用socket选项SO_KEEPALIVE（适合没有数据流动的情况）。

?> 心跳包技术：心跳包之所以叫心跳包是因为：它像心跳一样每隔固定时间发一次，以此来告诉服务器，这个客户端还活着。事实上这是为了保持长连接，至于这个包的内容，是没有什么特别规定的，不过一般都是很小的包，或者只包含包头的一个空包。

## **心跳包的发送，通常有两种技术：**

### **方法1：应用层自己实现的心跳包**。   

        由应用程序自己发送心跳包来检测连接是否正常。  
        大致的方法是：服务器端在一个 定时事件中 定时向客户端发送一个短小的数据包，然后启动一个线程，在该线程当中不断检测客户端的ACK应答包。如果在定时时间内收到了客户端的ACK应答包，说明客户端与服务器端的TCP连接仍然是可用的。但是，如果定时器已经超时、而服务器仍然没有收到客户端的ACK应答包，即可以认为客户端已经断开。同样道理，如果客户端在一定时间内没有收到服务器的心跳包，则也会认为改TCP连接不可用了。

?>**注释：原作者理解有误，心跳包应该由客户端在一个定时事件中定时向客户端发送一个短小的数据包，如果服务端收到客户端的心跳包或正常报文，则服务端的计数器归零；服务端启动一个定时器定时累加计数器，当计数器的累加值超过一定值时，则认为客户端断开。**


### **方法2：TCP协议的KeepAlive保活机制。**   

- 因为要考虑到一个服务器通常会连接很多个客户端，因此，由用户在应用层自己实现心跳包，代码较多而且稍显复杂。  
- 而利用TCP／IP协议层的内置的KeepAlive功能来实现心跳功能则简单得多。不论是服务器端还是客户端，只要一端开启KeepAlive功能后，就会自动的在规定时间内向对端发送心跳包， 而另一端在收到心跳包后就会自动回复，以告诉对端主机我仍然在线。  
- 因为开启KeepAlive功能需要消耗额外的宽带和流量，所以TCP协议层默认是不开启KeepAlive功能的。尽管这微不足道，但是在按流量计费的环境下增加了费用，另一方面，KeepAlive设置不合理的话有可能会 因为短暂的网络波动而断开健康的TCP连接。并且，默认的KeepAlive超时需要即2小时，探测次数为5次。对于很多服务端应用程序来说，2小时的空闲时间太长。因此，我们需要手工开启KeepAlive功能并设置合理的KeepAlive参数。